# Node.js - Adonis by 양재동 코드랩 강의

## 2 주차

### setting

- npm init adonis-ts-app@latest blog-platform
- npm run dev
- npm i @adonisjs/lucid
- node ace configure @adonisjs/lucid
- npm i @adonisjs/auth
- node ace configure @adonisjs/auth
- npm i phc-argon2
- 마이그레이션 파일에 컬럼 추가한 뒤 node ace migration:run

### blog-platform

- User 모델 업데이트 해야함(추가한 컬럼)
- lucid ORM은 Users 모델에서 카멜케이스로 작성한 것을 마이그레이션의 스네이크 케이스로 알아서 바꿔줌
- 아바타는 옵셔널하게 들어가는 값이니 Users 모델에서 ?를 붙여줌
- node ace migration:rollback -> 롤백해줌
- crud로 생성
- node ace make:controller Auth -> Auth 컨트롤러 생성
- 토큰 인증
  - auth middleware에서 registerNamed 설정을 해야함 -> kernel.ts에 추가하고 route에 인증이 필요한 api는 router.group으로 묶어줌
- ERD
  - 데이터의 설계 역활
  - 여러 테이블이 있고 관계를 형성할 때 의미가 있음
  - https://aquerytool.com/ 여기서 테스트할 수 있음
- ex: blog-platform.com
  - blog-platform.com/@/user1 -> 전략은 여러가지 세울 수 있음
    - api 단계에선 상관없음
    - 어떻게 주소단을 결정할지는 프론트단에서 결정해야함
  - user1.blog-platform.com - 제외
  - [GET] posts?displayName=user1 -> 서버는 restful하게
- findOrFail은 id 기준, findByOrFail은 문자열가능
- blog-platform.com/@user1
- blog-platform.com/@user1/2
  - 이전에 주소를 짧게 하려고 id 기준으로 썼었음
  - 요즘엔 주소 자체가 인터페이스의 하나로 보기때문에 blog-platform.com/@user1/첫-게시물 => 이렇게 하는 추세임
    - 이를 slug라고 함, 근데 저렇게 하면 첫-게시물이라는 제목이 중복되면 안됨 => 그래서 첫-게시물-elfdns1 이런식으로 해시를 달아 고유하게 만들기도함
- publish_at -> 발행시간, 사용자에게 등록시간을 변경할 수 있는 값을 주면, 미래 작업 또는 정렬 등이 편리해짐
- uuid
  - 절대 중복될 수 없는 것들의 값
  - 너무 길기 때문에 short-uuid나 mini-uuid 등을 사용할 수 있음
- 게시글 업데이트
  - 인증된 사용자 중에서도 본인만 수정되야함
  - 지금까지는 인증(Authentication)만 신경썼으나 권한(Authorization)도 신경써야함
  - npm i @adonisjs/bouncer
  - node ace configure @adonisjs/bouncer
  - start 폴더에 bouncer가 만들어지며 action을 만들어줌
- policies는 bouncer와 같은 기능을 제공하며, 따로 policy라는 파일을 만들어 사용함
  - bouncer 파일 registerPolicies 함수에 PostPolicy: () => import('App/Policies/PostPolicy')를 추가
  - PostPolicy에 정책을 써주고 바운서에서 authorize하기전에 언급만 하면됨
  - 갯수가 많아지고 코드 관리가 필요할 때는 policy를 쓰는 게 좋음
- 만든 것 또는 만들거
  - 인증
    - [POST] /auth/sign-up
    - [POST] /auth/sign-in
    - [GET] /auth/verify-token
    - [GET] /auth/verify-email
    - [GET] /auth/verify-display-name
    - TODO: 가입시 이메일 인증, 비밀번호 찾기 / 재설정
  - 프로필
    - [GET] /me
    - [PATCH] /me
    - [DELETE] /me
    - [GET] /me/posts
    - [GET] /me/posts/:slug
  - 포스트
    - [GET] /posts
    - [GET] /posts/:slug
  - 사용자
    - [GET] /users/:displayName
    - [GET] /users/:displayName/:slug
- 모델간 관계를 맺으려면 belongsTo
- query에서 preload
- 대댓글은 parent_id에서 comment모델 자기 참조함
  - 대댓글 갯수는 디자인적인 문제